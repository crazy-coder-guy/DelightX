<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DelightX</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Righteous&display=swap" rel="stylesheet">
    <style>
       
       body {
        background-color: #ffffff;
        font-family:  "Montserrat", sans-serif;
    }
    .navbar-brand {
font-family: "Righteous", sans-serif !important;
}
    button.qty-btn {
    width: 30px; /* Fixed width for buttons */
    margin: 5px; /* No margin between buttons */
    background-color: green; /* Green background for buttons */
    color: white; /* White text for buttons */
    border: none; /* Remove default border */
    border-radius: 4px; /* Optional: rounded corners */
    transition: background-color 0.2s; /* Smooth transition */
    
}
button.qty-btn:hover {
    background-color: darkgreen; /* Darker green on hover */
}
button.qty-btn:active {
    background-color: darkgreen; /* Keep darker green on click */
}
button.qty-btn:disabled {
    background-color: #4a4848; /* Disabled button color */
    cursor: not-allowed; /* Change cursor style */
}
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-img-top {
            border-radius: 12px;
            object-fit: contain;
            height: 80px;
        }
        .total-price {
            font-size: 1rem;
            font-weight: bold;
            color: #007bff;
        }
        .delete-btn {
            cursor: pointer;
            color: red;
            font-size: 0.9rem;
        }
        .price-text {
            font-size: 0.9rem;
        }
        .bg-light-gray {
            background-color: #ffffff;
        }
        .section-title {
            font-weight: 600;
            color: #343a40;
        }
        .price-details {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 15px;
        }
        .discount-price, .total-amount {
            color: green;
            font-weight: bold;
        }
        .amount-value {
            color: rgb(0, 0, 0);
            font-weight: 600;
        }
        @media (max-width: 576px) {
            h2 {
                font-size: 1.5rem;
                text-align: center; /* Center title on mobile */
            }
            .total-price {
                font-size: 1rem;
            }
            .delete-btn {
                font-size: 1rem;
            }
            .card-img-top {
                height: 60px;
            }
            .price-details {
                padding: 10px; /* Adjust padding for mobile */
            }
            .scrollable-column {
                padding: 5px; /* Less padding for mobile */
            }
        }
        @media (max-width: 768px) {
           
        .desktop-nav, .mobile-nav {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #ffffff;
        }
        .scrollable-column {
            max-height: 60vh; /* Adjust height as needed */
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px; /* Add some padding for better spacing */
        }
        .price-details {
            position: sticky;
            top: 0;
            background-color: #ffffff; /* Ensure background color for sticky */
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .pay-button {
            margin-bottom: 5%;
            font-size: 1rem; /* Larger font size */
            transition: background-color 0.3s; /* Smooth background color transition */
        }
        .pay-button:hover {
            background-color: #0056b3; /* Darker shade on hover */
        }
        }
        .delivery-message {
    opacity: 0;
    transform: translateY(20px); /* Move it slightly down */
    transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; /* Smooth transition for both opacity and position */
    margin-bottom: 20px; /* Adjust the value as needed */
    visibility: hidden; /* Use visibility for better control */
}
.delivery-message.visible {
    opacity: 1;
    transform: translateY(0); /* Reset position */
    visibility: visible; /* Make it visible */
}
#totalDiscount {
    display: none; /* This hides the element */
}
.fade-in {
    opacity: 0;
    transition: opacity 0.2s ease-in;
}
.fade-in.show {
    opacity: 1;
}
.delivery-message {
    display: none; /* Initially hidden */
    opacity: 0;
    transition: opacity 0.10s ease-in;
}
.delivery-message.visible {
    opacity: 1; /* Fade in */
}
    </style>

</head>
<body>

    <nav class="navbar navbar-light bg-light d-lg-none sticky-top">
        <div class="container-fluid justify-content-between">
            <a class="navbar-brand" href="#">DelightX</a>
        </div>
    </nav>
    
    <div class="offcanvas offcanvas-end offcanvas-full" tabindex="-1" id="searchOffcanvas" aria-labelledby="searchOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 id="searchOffcanvasLabel">Search</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <input type="text" class="form-control" placeholder="Search for over 500 products" autofocus>
        </div>
    </div>
    
    <!-- Desktop Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light d-none d-lg-block sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">DelightX</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Profile</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="moreDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            More
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="moreDropdown">
                            <li><a class="dropdown-item" href="#">Settings</a></li>
                            <li><a class="dropdown-item" href="#">Help</a></li>
                        </ul>
                    </li>
                </ul>
                <form class="d-flex">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                    <button class="btn btn-outline-success me-2" type="submit">Search</button>
                    <button class="btn btn-outline-secondary" type="button" aria-label="Cart">
                        <i class="fa-solid fa-cart-shopping fa-bounce"></i>
                    </button>
                </form>
            </div>
        </div>
    </nav>
    
    <!-- Bottom Navigation for Mobile -->
    <nav class="navbar navbar-light bg-light fixed-bottom d-lg-none bottom-nav">
        <div class="container-fluid justify-content-around">
            <a class="nav-link text-center" href="DelightX-Home.html">
                <i class="fas fa-home fa-lg"></i>
                <div>Home</div>
            </a>
            <a class="nav-link text-center" href="DelightX-Profile.html">
                <i class="fas fa-user fa-lg"></i>
                <div>Profile</div>
            </a>
            <a class="nav-link text-center" href="#">
                <i class="fas fa-ellipsis-h fa-lg"></i>
                <div>More</div>
            </a>
            <a class="nav-link text-center" href="DelightX-Cart.html">
                <i class="fas fa-shopping-cart fa-lg"></i>
                <div>Cart</div>
            </a>
        </div>
    </nav>
    
<div class="container mt-3">
    <h2 class="text-left mb-4 section-title">Shopping Cart</h2>
    <div class="row">
        <div class="col-lg-8 col-md-12 scrollable-column" id="cartItemsContainer">
            <div id="cartItems" class="row"></div>
            <img id="illustratorImage" src="src/undraw_empty_cart_co35.svg" alt="No items in cart" style="display: none; width: 100%; max-width: 400px; margin: auto;">
        </div>
        
        <div class="col-lg-4 col-md-12">
            <div class="price-details">
                <h5 class="text-center">
                    <i class="fa-solid fa-angle-up fa-bounce" id="scrollUpButton" style="cursor: pointer;"></i>
                </h5>                
                <h5 class="text-center">Price Details</h5>
                <div class="mb-3">
                    <strong>Total Amount:</strong> <span id="totalAmount" class="amount-value">0.00</span>
                </div>
                <div class="mb-3">
                    <strong>Delivery Charge:</strong> <span id="deliveryCharge">0.00</span>
                </div>
                <div class="mb-3">
                <span id="totalDiscount">0.00</span>
                </div>                
                <div class="mb-3">
                    <strong>You Save:</strong> <span id="totalSavings">0.00</span>
                </div>
                <div id="deliveryMessage" class="delivery-message mb-2" style="display: none;">
                    Your order will be delivered to your address by <span id="deliveryTime"></span>.
                </div>
                <div class="text-center mb-5">
                    <button id="payButton" class="btn btn-success btn-lg pay-button">Pay</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";
import { getDatabase, ref, get, remove, set, update } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";
 const firebaseConfig = {
        apiKey: "AIzaSyC7IZ7BhQPOy7CfEQLuJTOxdrTybBZTFO8",
        authDomain: "delightx-in.firebaseapp.com",
        databaseURL: "https://delightx-in-default-rtdb.firebaseio.com",
        projectId: "delightx-in",
        storageBucket: "delightx-in.appspot.com",
        messagingSenderId: "554333595542",
        appId: "1:554333595542:web:d445cd0bea3f1483c21fb7"
    };
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth(app);

let currentUserUid = null; // Declare at the top level

onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUserUid = user.uid;
        console.log("User is logged in:", currentUserUid);
        await fetchCart(); // Fetch cart items after user logs in
    } else {
        console.log("User is not logged in. Redirecting to index.html.");
        window.location.href = "index.html"; 
    }
});
async function fetchCart() {
    if (!currentUserUid) {
        console.warn("User not logged in. Checking local storage for cart.");
        loadCartFromLocalStorage(); // Attempt to load cart from local storage
        return;
    }

    const cartRef = ref(database, `carts/${currentUserUid}`);
    const snapshot = await get(cartRef);
    if (snapshot.exists()) {
        const cart = snapshot.val();
        renderCart(cart); // Render the cart items
        storeCartInLocalStorage(cart); // Save cart to local storage
    } else {
        console.log("No cart data available in Firebase.");
        loadCartFromLocalStorage(); // Load from local storage if no data in Firebase
    }
}

// Function to load cart from local storage
function loadCartFromLocalStorage() {
    const cart = JSON.parse(localStorage.getItem(`cart_${currentUserUid}`));
    if (cart) {
        console.log("Loaded cart from local storage:", cart);
        renderCart(cart); // Render the cart from local storage
    } else {
        console.log("No cart found in local storage.");
        renderCart({}); // Render empty cart if no data found
    }
}

// Function to store cart in local storage
function storeCartInLocalStorage(cart) {
    localStorage.setItem(`cart_${currentUserUid}`, JSON.stringify(cart));
    console.log("Stored cart in local storage.");
}

function calculateFinalAmountWithDelivery(cart) {
    let total = 0;
    Object.values(cart).forEach(item => {
        total += parseFloat(item.finalPrice) * item.quantity;
    });

    // Delivery charge logic
    let deliveryCharge = 0;
    if (total < 500) {
        deliveryCharge = 49;
    } else if (total < 1000) {
        deliveryCharge = 39;
    } else if (total < 2000) {
        deliveryCharge = 29;
    }

    return total + deliveryCharge; // Add delivery charge
}


document.addEventListener("DOMContentLoaded", function () {
    const deliveryMessage = document.getElementById("deliveryMessage");
    const deliveryTime = document.getElementById("deliveryTime");
    function checkDeliveryTime() {
        const now = new Date();
        const hours = now.getHours();
        let delivery;
        if (hours >= 16) { // If time is 4 PM or later
            delivery = "tomorrow by 6 PM";
        } else {
            delivery = "today";
        }
        deliveryTime.textContent = delivery;
    }
    // Initial check for delivery time
    checkDeliveryTime();
    // Function to show the delivery message
function showDeliveryMessage() {
    setTimeout(() => {
        deliveryMessage.style.display = "block"; // Show message
        deliveryMessage.classList.add('visible'); // Add visible class for fade-in effect
    }, 2000); // Delay of 2 seconds
}
// Scroll effect
window.addEventListener('scroll', function () {
    const rect = deliveryMessage.getBoundingClientRect();
    const isVisible = rect.top <= window.innerHeight && rect.bottom >= 0;
    // Check if the delivery message is not yet displayed
    if (!isVisible && (rect.top <= window.innerHeight)) {
        showDeliveryMessage(); // Show message when user scrolls
    }
});
// Check if the delivery message is visible on page load
window.addEventListener('load', function () {
    const rect = deliveryMessage.getBoundingClientRect();
    // If it's already in the viewport
    if (rect.top <= window.innerHeight && rect.bottom >= 0) {
        showDeliveryMessage();
    }
});
});


document.getElementById('payButton').addEventListener('click', async () => {
    const uid = auth.currentUser.uid;
    const userRef = ref(database, `users/${uid}`);
    const userSnapshot = await get(userRef);
    // Check if user data exists
    if (!userSnapshot.exists()) {
        alert('Your profile is incomplete. Please update your address and mobile number.');
        window.location.href = 'profile.html'; 
        return;
    }
    const userData = userSnapshot.val();
    console.log('User    data:', userData); 
    // Check if user details are complete
    if (!userData.fullName || !userData.address || !userData.mobile) {
        alert('Please update your profile with your name, address, and mobile number.');
        window.location.href = 'profile.html'; 
        return;
    }
    const cartRef = ref(database, `carts/${uid}`);
    const snapshot = await get(cartRef);
    if (snapshot.exists()) {
        const cart = snapshot.val();
        // Check stock availability for each product in the cart
        const stockAvailability = await checkStockAvailability(cart);
        if (!stockAvailability) {
            alert(stockAvailability);
            return;
        }
        // Check if user selected quantity is greater than stock available
        const quantityCheck = await checkQuantity(cart);
        if (!quantityCheck) {
            alert('Sorry, the quantity you selected is greater than the stock available. Please try again later.');
            return;
        }
        // Calculate total amount including delivery charge
        const totalAmount = calculateFinalAmountWithDelivery(cart);
        // Prepare Razorpay payment options
        const options = {
            key: "rzp_test_XxEv4eXXqaPM4o", 
            amount: (totalAmount * 100).toFixed(0), 
            currency: "INR",
            name: "QuickBuy",
            description: "Your Order Description",
            handler: async function(response) {
                // Create order after successful payment
                await createOrder(cart);
                await removeAllCartItems();
                alert('Payment successful! Your cart has been cleared.');
            },
            prefill: {
                name: userData.fullName || "Customer Name",
                email: userData.email || "customer@example.com",
                contact: userData.mobile || "9999999999"
            },
            theme: {
                color: "#F37254"
            }
        };
        const razorpay = new Razorpay(options);
        razorpay.open();
    } else {
        alert('Your cart is empty.');
    }
});
async function removeAllCartItems() {
    const cartRef = ref(database, `carts/${currentUserUid}`);
    try {
        await remove(cartRef);
        console.log('All items removed from cart.');
        localStorage.removeItem(`cart_${currentUserUid}`);
        fetchCart();
    } catch (error) {
        console.error('Error removing cart items:', error);
    }
}
async function checkStockAvailability(cart) {
    for (const productId in cart) {
        const productRef = ref(database, `products/${productId}`);
        const snapshot = await get(productRef);
        if (snapshot.exists()) {
            const productData = snapshot.val();
            const currentStock = productData.stockAvailable;
            const quantityOrdered = cart[productId].quantity;
            if (currentStock < quantityOrdered) {
                return `Sorry, the product ${productId} is out of stock. Please try again later.`; 
            }
        } else {
            return `Sorry, the product ${productId} does not exist. Please try again later.`; 
        }
    }
    return true; 
}
async function checkQuantity(cart) {
    for (const productId in cart) {
        const productRef = ref(database, `products/${productId}`);
        const snapshot = await get(productRef);
        if (snapshot.exists()) {
            const productData = snapshot.val();
            const currentStock = productData.stockAvailable;
            const quantityOrdered = cart[productId].quantity;
            if (quantityOrdered > currentStock) {
                return false;
            }
        } else {
            return false;
        }
    }
    return true;
}
async function renderCart(cart) {
    const cartItemsContainer = document.getElementById('cartItems');
    const totalAmountElement = document.getElementById('totalAmount');
    const totalMRPElement = document.getElementById('totalMRP');
    const totalDiscountElement = document.getElementById('totalDiscount');
    const totalSavingsElement = document.getElementById('totalSavings');
    const deliveryChargeElement = document.getElementById('deliveryCharge');
    const illustratorImage = document.getElementById('illustratorImage');
    cartItemsContainer.innerHTML = '';
    
    // Check if the cart is empty
    if (!cart || Object.keys(cart).length === 0) {
        illustratorImage.style.display = 'block'; // Show the image
        totalAmountElement.innerHTML = '<span class="amount-value">₹0.00</span>';
        deliveryChargeElement.innerHTML = 'Free Delivery'; // Set delivery charge to "Free Delivery"
        return; // Exit the function if the cart is empty
    } else {
        illustratorImage.style.display = 'none'; // Hide the illustrator image if not empty
    }

    let totalAmount = 0;
    let totalMRP = 0;
    let totalDiscount = 0;
    
    Object.entries(cart).forEach(([key, item]) => {
        const col = document.createElement('div');
        col.className = 'col-12 mb-3 bg-light-gray';
        const row = document.createElement('div');
        row.className = 'row align-items-center';
        const imgCol = document.createElement('div');
        imgCol.className = 'col-3';
        const img = document.createElement('img');
        img.src = item.imageURL;
        img.className = 'card-img-top';
        imgCol.appendChild(img);
        row.appendChild(imgCol);
        const nameQtyCol = document.createElement('div');
        nameQtyCol.className = 'col-5';
        const title = document.createElement('h6');
        title.className = 'card-title mb-0';
        title.textContent = item.productName;
        nameQtyCol.appendChild(title);

        // Create quantity controls
        const qtyCol = document.createElement('div');
        qtyCol.className = 'qty-controls';
        const decrementBtn = document.createElement('button');
        decrementBtn.textContent = '-';
        decrementBtn.className = 'qty-btn';
        decrementBtn.addEventListener('click', () => {
            if (item.quantity > 1) {
                item.quantity--;
                updateQtyDisplay();
                updateCart(item, key); // Pass the current item and its key
            }
        });
        const qtyDisplay = document.createElement('span');
        qtyDisplay.className = 'qty-display';
        qtyDisplay.textContent = item.quantity;
        const incrementBtn = document.createElement('button');
        incrementBtn.textContent = '+';
        incrementBtn.className = 'qty-btn';
        incrementBtn.addEventListener('click', () => {
            if (item.quantity < Math.min(item.availableQuantity, 5)) {
                item.quantity++;
                updateQtyDisplay();
                updateCart(item, key); // Pass the current item and its key
            }
        });
        qtyCol.appendChild(decrementBtn);
        qtyCol.appendChild(qtyDisplay);
        qtyCol.appendChild(incrementBtn);
        qtyCol.appendChild(document.createTextNode(` ${item.availableQuantity} ${item.qtyUnit}`));
        nameQtyCol.appendChild(qtyCol);
        row.appendChild(nameQtyCol);
        const priceCol = document.createElement('div');
        priceCol.className = 'col-2';
        const finalPrice = document.createElement('p');
        finalPrice.className = 'price-text';
        finalPrice.innerHTML = `₹${(item.finalPrice * item.quantity).toFixed(2)}`;
        priceCol.appendChild(finalPrice);
        row.appendChild(priceCol);
        const deleteCol = document.createElement('div');
        deleteCol.className = 'col-2 text-center';
        const deleteBtn = document.createElement('span');
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.className = 'delete-btn';
        deleteBtn.addEventListener('click', () => {
            removeCartItem(key);
        });
        deleteCol.appendChild(deleteBtn);
        row.appendChild(deleteCol);
        col.appendChild(row);
        cartItemsContainer.appendChild(col);
        const itemQuantity = parseInt(item.quantity);
        const itemFinalPrice = parseFloat(item.finalPrice);
        const itemOriginalPrice = parseFloat(item.originalPrice);
        totalAmount += itemFinalPrice * itemQuantity;
        totalMRP += itemOriginalPrice * itemQuantity;
        totalDiscount += (itemOriginalPrice - itemFinalPrice) * itemQuantity;

        /// Check stock availability every second
        const productId = key;
        const productRef = ref(database, `products/${productId}`);
        const stockCheckInterval = setInterval(async () => {
            const snapshot = await get(productRef);
            if (snapshot.exists()) {
                const productData = snapshot.val();
                const currentStock = productData.stockAvailable;
                item.availableQuantity = currentStock; // Update item available quantity
                // Update visual elements based on available stock
                checkQuantityLimit();
                if (currentStock <= 0) {
                    // Update image to black and white if stock is 0
                    col.style.textDecoration = 'line-through';
                    img.style.filter = 'grayscale(100%)';
                    img.style.opacity = '0.5';
                    incrementBtn.disabled = true; // Disable increment if out of stock
                } else {
                    // Reset image if stock is available
                    img.style.filter = '';
                    img.style.opacity = '';
                }
                // Check quantity limit
                checkQuantityLimit();
            }
        }, 1000); // Check every second
        
        function updateQtyDisplay() {
            qtyDisplay.textContent = item.quantity;
            finalPrice.innerHTML = `₹${(item.finalPrice * item.quantity).toFixed(2)}`;
            if (item.quantity > item.availableQuantity) {
                col.style.textDecoration = 'line-through'; // Strike through if quantity exceeds stock
            } else {
                col.style.textDecoration = ''; // Remove strike through if quantity is valid
                img.style.filter = ''; // Reset image color
                img.style.opacity = '';
            }
            // Recalculate totals and update delivery charge
            recalculateTotals();
        }

        function checkQuantityLimit() {
            if (item.quantity >= item.availableQuantity) {
                incrementBtn.disabled = true; // Disable increment button
                if (item.quantity > item.availableQuantity) {
                    col.style.textDecoration = 'line-through'; // Strike through if quantity exceeds stock
                }
            } else {
                incrementBtn.disabled = false; // Enable increment button
            }
        }
    });
    
    // Initial delivery charge logic
    recalculateTotals();

    // New function to recalculate totals and update the UI
function recalculateTotals() {
    let totalAmount = 0;
    let totalDiscount = 0; // Added to calculate total discount
    
    Object.values(cart).forEach(item => {
        totalAmount += parseFloat(item.finalPrice) * item.quantity;
        const itemOriginalPrice = parseFloat(item.originalPrice);
        totalDiscount += (itemOriginalPrice - item.finalPrice) * item.quantity; // Calculate discount
    });

    // Delivery charge logic
    let deliveryCharge = 0;
    if (totalAmount < 500) {
        deliveryCharge = 49;
    } else if (totalAmount < 1000) {
        deliveryCharge = 39;
    } else if (totalAmount < 2000) {
        deliveryCharge = 29;
    }

    // Update total amounts in the UI
    totalAmountElement.innerHTML = `<span class="amount-value"><span class="strike-through">₹${calculateTotalAmount(cart).toFixed(2)}</span> ₹${(totalAmount + deliveryCharge).toFixed(2)}</span>`;
    totalSavingsElement.innerHTML = `₹${totalDiscount.toFixed(2)}`;
    deliveryChargeElement.innerHTML = `₹${deliveryCharge}`; // Show the calculated delivery charge
}

// Update cart logic
function updateCart(item, key) {
    // Update Firebase with the current cart item
    const cartRef = ref(database, `carts/${currentUserUid}/${key}`);
    const updatedItem = { quantity: item.quantity }; // Create an object with only the updated quantity
    // Use update to only modify the quantity field
    update(cartRef, updatedItem)
        .then(() => {
            console.log('Quantity updated successfully');
        })
        .catch((error) => {
            console.error('Error updating quantity:', error);
        });
}

// CSS for the animation and button styling
const style = document.createElement('style');
style.innerHTML = `
    .strike-through {
        animation: strikeThrough 1s forwards;
    }
    @keyframes strikeThrough {
        from {
            opacity: 1;
        }
        to {
            opacity: 0.5;
            text-decoration: line-through;
        }
    }
    .qty-btn {
        margin: 0 5px;
        padding: 2px 5px; /* Reduced padding for smaller size */
        cursor: pointer;
        font-size: 16px; /* Adjust font size */
        border: 1px solid #ccc; /* Add border for better visibility */
        border-radius: 4px; /* Rounded corners */
        background-color: #f0f0f0; /* Background color */
        transition: background-color 0.2s; /* Smooth transition */
    }
    .qty-btn:hover {
        background-color: #e0e0e0; /* Change color on hover */
    }
    .qty-btn:disabled {
        background-color: #ddd; /* Disabled button color */
        cursor: not-allowed; /* Change cursor style */
    }
`;
document.head.appendChild(style);
}


async function removeCartItem(productId) {
    const cartRef = ref(database, `carts/${currentUserUid}`); // Use currentUserUid instead of currentUserId
    try {
        const snapshot = await get(cartRef);
        if (snapshot.exists()) {
            const cart = snapshot.val();
            delete cart[productId];
            await set(cartRef, cart);
            console.log('Item removed:', productId);
            storeCartInLocalStorage(cart);
            fetchCart();
        }
    } catch (error) {
        console.error('Error deleting item:', error);
    }
}


function getStoredLocation() {
    const storedData = localStorage.getItem("userLocation");
    if (storedData) {
        const locationData = JSON.parse(storedData);
        const currentTime = Date.now();

        if (currentTime - locationData.timestamp < 3600000) {
            return {
                latitude: locationData.latitude,
                longitude: locationData.longitude,
            };
        } else {
            localStorage.removeItem("userLocation");
        }
    }
    return null;
}

async function createOrder(cart) {
    const uid = auth.currentUser.uid;
    
    // Fetch user data to get the email and other details
    const userSnapshot = await get(ref(database, `users/${uid}`));
    const userData = userSnapshot.val();
    const userEmail = userData.email; 
    const userfullname = userData.fullName; 
    const userMobilenumber = userData.mobile;
    const userAddress = userData.address;  

    // Fetch user's location using the getStoredLocation function
    const userLocation = getStoredLocation();
    const userLat = userLocation ? userLocation.latitude : null;
    const userLng = userLocation ? userLocation.longitude : null;

    const orderId = `order_${uid}_${Date.now()}_${Math.floor(Math.random() * 10000)}`; 
    const orderData = {
        userName: userfullname,
        usermobilenumber: userMobilenumber,
        useraddress: userAddress,
        orderId: orderId,
        userId: uid,
        userEmail: userEmail, 
        items: cart,
        totalAmount: calculateTotalAmount(cart),
        orderDate: new Date().toISOString(),
        isNew: true, // Set isNew property to true
        latitude: userLat, // Store user's latitude
        longitude: userLng  // Store user's longitude
    };
    
    const ordersRef = ref(database, `orders/${uid}/${orderId}`);
    await set(ordersRef, orderData);
    console.log('Order created:', orderData);
    
    // Update stock availability for each product in the cart
    await updateStockAvailability(cart);
}

async function updateUserLocation(uid, latitude, longitude) {
    const userRef = ref(database, `users/${uid}`);
    await update(userRef, {
        location: {
            latitude: latitude,
            longitude: longitude
        }
    });
}

async function updateStockAvailability(cart) {
    for (const productId in cart) {
        const productRef = ref(database, `products/${productId}`);
        const snapshot = await get(productRef);
        if (snapshot.exists()) {
            const productData = snapshot.val();
            const currentStock = productData.stockAvailable;
            const quantityOrdered = cart[productId].quantity;
            if (currentStock >= quantityOrdered) {
                const newStock = currentStock - quantityOrdered;
                await update(productRef, { stockAvailable: newStock });
                console.log(`Updated stock for product ${productId}: ${newStock}`);
            } else {
                console.error(`Insufficient stock for product ${productId}`);
            }
        } else {
            console.error(`Product ${productId} not found`);
        }
    }
}
function calculateTotalAmount(cart) {
    let total = 0;
    Object.values(cart).forEach(item => {
        total += item.originalPrice * item.quantity;
    });
    return total;
}
// Hide the total discount element
document.getElementById('totalDiscount').style.display = 'none';
// You can still calculate and use totalDiscount in your logic
function calculateTotalDiscount(cart) {
    let totalDiscount = 0;
    Object.values(cart).forEach(item => {
        totalDiscount += item.discount * item.quantity; // Assuming `item.discount` is the discount per item
    });
    return totalDiscount;
}
document.getElementById('scrollUpButton').addEventListener('click', function() {
    // Scroll up by 100 pixels (adjust the value as needed)
    window.scrollBy({
        top: 1000, // Scroll up
        behavior: 'smooth' // Smooth scrolling
    });
});
</script>
</body>
</html>